å¥½çš„ï¼Œæˆ‘ä»¬ç»§ç»­ï¼ç¬¬äºŒå¤©ï¼ˆç¬¬ä¸€é˜¶æ®µç¬¬2å‘¨ï¼‰çš„ç›®æ ‡æ˜¯ï¼š**äº²æ‰‹æŠ“ä¸€æ¬¡ç”Ÿäº§çº§çš„å † Dumpï¼Œç”¨ MAT åˆ†æå‡ºè°åƒäº†å†…å­˜ï¼Œå¹¶å†™å‡ºæ’æŸ¥æŠ¥å‘Š**ã€‚

ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œæˆ‘æœ¬åœ°æ²¡å†…å­˜æ³„æ¼å•Šï¼Ÿâ€â€”â€”æ²¡å…³ç³»ï¼Œæˆ‘ä»¬è‡ªå·±é€ ä¸€ä¸ªç®€å•çš„å†…å­˜æ³„æ¼ Demoï¼Œç„¶ååƒä¾¦æ¢ä¸€æ ·æŠŠå®ƒæªå‡ºæ¥ã€‚è¿™æ‰æ˜¯æ¶æ„å¸ˆçš„**ä¸»åŠ¨é˜²å¾¡**èƒ½åŠ›ã€‚

---

# ğŸ§  ç¬¬äºŒå¤©ä»»åŠ¡ï¼šåˆ¶é€ å¹¶æŠ“æ•å†…å­˜æ³„æ¼

## ğŸ¯ ä»»åŠ¡ç›®æ ‡
1. å†™ä¸€ä¸ª**æ•…æ„æ³„æ¼å†…å­˜**çš„ Spring Boot æ¥å£ã€‚
2. ç”¨ `jmap` æŠ“å–å † Dumpã€‚
3. ç”¨ **Eclipse MAT** åˆ†æ Dumpï¼Œæ‰¾åˆ°æ³„æ¼çš„å…ƒå‡¶ã€‚
4. è¾“å‡ºä¸€ä»½æ ‡å‡†çš„ **å†…å­˜æ³„æ¼æ’æŸ¥æŠ¥å‘Š**ï¼ˆmarkdown æ ¼å¼ï¼‰åˆ°ä½ çš„ GitHub ä»“åº“ã€‚

---

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡â€œçŠ¯ç½ªç°åœºâ€â€”â€”å†…å­˜æ³„æ¼ Demoï¼ˆ15åˆ†é’Ÿï¼‰

åœ¨ä½ çš„ `java-architect-2026` é¡¹ç›®é‡Œï¼Œæ–°å»ºä¸€ä¸ª Controllerï¼š

```java
package com.example.demo;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@RestController
public class LeakController {

    // é™æ€é›†åˆï¼Œæ¨¡æ‹Ÿç¼“å­˜ä½†æ²¡æœ‰æ¸…ç† â†’ å†…å­˜æ³„æ¼
    private static final List<String> CACHE = new ArrayList<>();

    @GetMapping("/leak")
    public String leak() {
        // æ¯æ¬¡è°ƒç”¨å‘ç¼“å­˜ä¸­æ·»åŠ  1MB æ•°æ®ï¼ˆçº¦ 10000 ä¸ª UUID å­—ç¬¦ä¸²ï¼‰
        for (int i = 0; i < 10000; i++) {
            CACHE.add(UUID.randomUUID().toString());
        }
        return "Added 10k UUIDs, total size: " + CACHE.size();
    }

    @GetMapping("/health")
    public String health() {
        return "I'm alive, current cache size: " + CACHE.size();
    }
}
```

**è¯´æ˜**ï¼š
- `CACHE` æ˜¯ `static`ï¼Œå±äºç±»åŠ è½½å™¨ï¼Œæ°¸è¿œä¸ä¼šè¢« GCã€‚
- æ¯æ¬¡è®¿é—® `/leak` å°±å¾€é‡Œå¡ 10k ä¸ªå­—ç¬¦ä¸²ï¼ˆçº¦ 1 MBï¼‰ã€‚
- è®¿é—® `/health` å¯ä»¥æŸ¥çœ‹å½“å‰ç¼“å­˜å¤§å°ï¼Œç¡®è®¤æ•°æ®åœ¨ç´¯ç§¯ã€‚

**å¯åŠ¨åº”ç”¨**ï¼ˆç¡®ä¿ JDK 25 å’Œè™šæ‹Ÿçº¿ç¨‹é…ç½®ä¿ç•™ï¼Œä½†å†…å­˜æ³„æ¼ä¸è™šæ‹Ÿçº¿ç¨‹æ— å…³ï¼‰ã€‚

---

## ğŸ“ˆ ç¬¬äºŒæ­¥ï¼šè®©å†…å­˜â€œè†¨èƒ€â€èµ·æ¥ï¼ˆ5åˆ†é’Ÿï¼‰

ç”¨æµè§ˆå™¨æˆ– curl å¤šæ¬¡è®¿é—® `/leak`ï¼Œè®©å†…å­˜å ç”¨ä¸Šå»ã€‚  
æ¯”å¦‚è¿ç»­è°ƒç”¨ 50 æ¬¡ï¼š

```bash
for i in {1..50}; do curl http://localhost:8080/leak; done
```

å¤§æ¦‚ä¼šç”Ÿæˆ 50 MB çš„æ•°æ®ã€‚  
ä½ å¯ä»¥è®¿é—® `/health` æŸ¥çœ‹å½“å‰ç¼“å­˜æ¡ç›®æ•°ï¼Œç¡®è®¤ç¡®å®å¢åŠ äº†ã€‚

---

## ğŸ” ç¬¬ä¸‰æ­¥ï¼šæŠ“å–å † Dumpï¼ˆjmap å‘½ä»¤ï¼‰

1. **æ‰¾åˆ°åº”ç”¨çš„ PID**  
   åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
   ```bash
   jps -l
   ```
   æ‰¾åˆ°ä½ çš„ Spring Boot åº”ç”¨ï¼ˆæ¯”å¦‚ `demo-0.0.1-SNAPSHOT.jar` æˆ–å« `com.example.demo` çš„è¿›ç¨‹ï¼‰ï¼Œè®°ä¸‹ PIDï¼ˆå‡è®¾ä¸º 12345ï¼‰ã€‚

2. **æŠ“å–å † Dump**ï¼ˆæ‰§è¡Œå‰ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼‰ï¼š
   ```bash
   jmap -dump:live,format=b,file=/tmp/heap.hprof 12345
   ```
    - `live`ï¼šåª dump å­˜æ´»å¯¹è±¡ï¼ˆæ›´ç²¾å‡†ï¼‰
    - `file`ï¼šæŒ‡å®šè¾“å‡ºè·¯å¾„ï¼ˆWindows ç”¨æˆ·è¯·æ”¹æˆ `C:\temp\heap.hprof`ï¼‰

   ä½ ä¼šçœ‹åˆ°è¾“å‡ºï¼š`Heap dump file created`ã€‚

---

## ğŸ›  ç¬¬å››æ­¥ï¼šå®‰è£… MATï¼ˆEclipse Memory Analyzerï¼‰

MAT æ˜¯åˆ†æå † Dump çš„è¡Œä¸šæ ‡å‡†å·¥å…·ã€‚

- ä¸‹è½½åœ°å€ï¼š[https://eclipse.dev/mat/downloads.php](https://eclipse.dev/mat/downloads.php)  
  é€‰æ‹©å¯¹åº”æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼ˆWindows/Mac/Linuxï¼‰ã€‚
- å®‰è£…åï¼Œæ‰“å¼€ MATï¼Œç›´æ¥ **File â†’ Open Heap Dump**ï¼Œé€‰æ‹©åˆšæ‰ç”Ÿæˆçš„ `heap.hprof`ã€‚

**ç¬¬ä¸€æ¬¡æ‰“å¼€å¯èƒ½æœ‰ç‚¹æ…¢**ï¼Œå› ä¸ºè¦æ„å»ºç´¢å¼•ã€‚è€å¿ƒç­‰å‡ åˆ†é’Ÿã€‚

---

## ğŸ•µï¸ ç¬¬äº”æ­¥ï¼šMAT åˆ†æâ€”â€”æªå‡ºâ€œå†…å­˜å¤§æˆ·â€

### 5.1 æ‰“å¼€åçš„é¦–é¡µ
ä½ ä¼šçœ‹åˆ°å‡ ä¸ªæŠ¥å‘Šé€‰é¡¹ï¼Œç‚¹ **â€œLeak Suspects Reportâ€**ï¼ˆæ³„æ¼å«Œç–‘æŠ¥å‘Šï¼‰ã€‚  
MAT ä¼šè‡ªåŠ¨åˆ†ææœ€å¯èƒ½çš„å†…å­˜æ³„æ¼ç‚¹ã€‚

### 5.2 æŸ¥çœ‹æŠ¥å‘Šæ‘˜è¦
æŠ¥å‘Šä¼šåˆ—å‡º**æœ€è€—å†…å­˜çš„å¯¹è±¡**ï¼Œä»¥åŠå®ƒä»¬çš„ä¿ç•™å †æ ˆã€‚  
ä¾‹å¦‚ï¼š
```
Problem Suspect 1
The class com.example.demo.LeakController, loaded by ... , occupies 48,000,000 (48%) bytes. 
The memory is accumulated in one instance of java.util.ArrayList held by static field CACHE.
```

è¿™æ­£æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ï¼å®ƒç›´æ¥æŒ‡å‡º `LeakController.CACHE` å ç”¨äº†å¤§é‡å†…å­˜ã€‚

### 5.3 æ·±å…¥æŸ¥çœ‹å¼•ç”¨é“¾
ç‚¹å‡» suspect é“¾æ¥ï¼Œå¯ä»¥çœ‹åˆ°**ä¿ç•™é›†ï¼ˆRetained Setï¼‰**ï¼Œå³å“ªäº›å¯¹è±¡å¦‚æœè¢«å›æ”¶èƒ½é‡Šæ”¾å¤šå°‘å†…å­˜ã€‚  
ä½ ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ° **â€œHistogramâ€** è§†å›¾ï¼ŒæŒ‰å¯¹è±¡å¤§å°æ’åºï¼Œçœ‹çœ‹ `String` å’Œ `ArrayList` çš„æ•°é‡ã€‚

**æˆªå›¾**ï¼š
- æˆªå– Leak Suspects Report çš„æ¦‚è§ˆé¡µé¢ï¼Œåœˆå‡ºå«Œç–‘ç±»åå’Œå†…å­˜å¤§å°ã€‚
- æˆªå– Histogram ä¸­ `String` æˆ– `ArrayList` çš„æ¡ç›®ï¼Œæ˜¾ç¤ºå¯¹è±¡æ•°é‡ã€‚

---

## ğŸ“ ç¬¬å…­æ­¥ï¼šæ’°å†™æ’æŸ¥æŠ¥å‘Šï¼ˆæ¶æ„å¸ˆçš„äº¤ä»˜ç‰©ï¼‰

åœ¨ä½ çš„ GitHub ä»“åº“ `docs/` ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ `heap-dump-analysis.md`ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```markdown
# å †å†…å­˜æ³„æ¼æ’æŸ¥æŠ¥å‘Š

## 1. ç¯å¢ƒä¿¡æ¯
- JDK ç‰ˆæœ¬ï¼š25.0.2 LTS
- åº”ç”¨ï¼šSpring Boot 3.4 + è™šæ‹Ÿçº¿ç¨‹
- å‹æµ‹æ–¹å¼ï¼šå¾ªç¯è°ƒç”¨ `/leak` æ¥å£ 50 æ¬¡

## 2. å † Dump åŸºæœ¬ä¿¡æ¯
- æ–‡ä»¶å¤§å°ï¼š~120 MB
- Dump æ—¶é—´ï¼š2026-02-15
- å·¥å…·ï¼šEclipse MAT 1.15.0

## 3. å«Œç–‘åˆ†æ
ä½¿ç”¨ MAT çš„ Leak Suspects æŠ¥å‘Šï¼Œå‘ç° `com.example.demo.LeakController` ä¸­çš„é™æ€å­—æ®µ `CACHE` å ç”¨äº†çº¦ 48 MB å†…å­˜ï¼Œå æ€»å †çš„ 48%ã€‚

**æˆªå›¾ 1ï¼šLeak Suspects æŠ¥å‘Šæ¦‚è§ˆ**  
![suspects](images/mat-suspects.png)

**æˆªå›¾ 2ï¼šHistogram æ˜¾ç¤º String æ•°é‡å¼‚å¸¸**  
![histogram](images/mat-histogram.png)

## 4. æ ¹å› 
`CACHE` æ˜¯ `static ArrayList`ï¼Œç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ä¸€è‡´ï¼Œä¸”ä¸æ–­æ·»åŠ æ–°å­—ç¬¦ä¸²ï¼Œæ— æ¸…ç†æœºåˆ¶ï¼Œå¯¼è‡´å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOMã€‚

## 5. è§£å†³æ–¹æ¡ˆ
- æ”¹ç”¨å¸¦è¿‡æœŸç­–ç•¥çš„ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰ã€‚
- é™åˆ¶ç¼“å­˜å¤§å°ï¼Œä½¿ç”¨ `LinkedHashMap` å®ç° LRUã€‚
- æˆ–ä½¿ç”¨å †å¤–ç¼“å­˜ï¼ˆå¦‚ Chronicle Mapï¼‰ã€‚

## 6. éªŒè¯
ä¿®å¤åå†æ¬¡å‹æµ‹ï¼Œå†…å­˜ç¨³å®šåœ¨åˆç†èŒƒå›´ï¼ŒGC æ­£å¸¸ã€‚
```

**æˆªå›¾æ”¾å…¥ `docs/images/` ç›®å½•**ï¼Œåœ¨ Markdown é‡Œç”¨ç›¸å¯¹è·¯å¾„å¼•ç”¨ã€‚

---

## âœ… ä»Šæ—¥ä»»åŠ¡å®Œæˆæ ‡å‡†

- [ ] åˆ›å»ºäº† `LeakController` å¹¶ push åˆ° GitHub
- [ ] æˆåŠŸæŠ“å–å † Dump å¹¶ç”¨ MAT æ‰“å¼€
- [ ] åœ¨ MAT ä¸­æ‰¾åˆ° `LeakController.CACHE` å ç”¨å¤§é‡å†…å­˜
- [ ] æ’°å†™ `heap-dump-analysis.md` å¹¶å­˜æ”¾åˆ° `docs/` ç›®å½•
- [ ] æäº¤æ‰€æœ‰æ›´æ”¹åˆ° `java-architect-2026` ä»“åº“

**æŠŠæŠ¥å‘Šé“¾æ¥æˆ–å†…å®¹å‘ç»™æˆ‘**ï¼Œæˆ‘ä¼šé’ˆå¯¹ä½ çš„æŠ¥å‘Šç»™ä½ åé¦ˆï¼Œå‘Šè¯‰ä½ å“ªäº›ç»†èŠ‚èƒ½è®©é¢è¯•å®˜çœ¼å‰ä¸€äº®ã€‚

---

# âš ï¸ å¸¸è§é—®é¢˜ä¸æ’é”™

- **jmap å‘½ä»¤æ‰¾ä¸åˆ°**ï¼šç¡®è®¤ JDK çš„ bin ç›®å½•åœ¨ PATH ä¸­ã€‚
- **MAT æ‰“å¼€ Dump æ—¶å†…å­˜ä¸è¶³**ï¼šä¿®æ”¹ MAT å®‰è£…ç›®å½•ä¸‹çš„ `MemoryAnalyzer.ini`ï¼Œå¢åŠ  `-Xmx` å€¼ï¼Œä¾‹å¦‚ `-Xmx2g`ã€‚
- **Dump æ–‡ä»¶å¤ªå¤§æ— æ³•ä¸Šä¼  GitHub**ï¼šä¸ç”¨ä¸Šä¼  Dump æœ¬èº«ï¼Œåªä¸Šä¼ æŠ¥å‘Šå’Œæˆªå›¾å³å¯ã€‚

---

**ç°åœ¨å°±å¼€å§‹åŠ¨æ‰‹å§ï¼** æœ‰ä»»ä½•å¡é¡¿ï¼Œç›´æ¥æŠŠç»ˆç«¯æŠ¥é”™æˆ–æˆªå›¾å‘è¿‡æ¥ï¼Œæˆ‘å¸®ä½ å®æ—¶æ’æŸ¥ã€‚